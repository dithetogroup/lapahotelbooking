import{L as Z}from"./chunk-XJPX7IZZ.js";import{E as I,Fb as q,Gb as Q,H as M,Ia as C,N as H,R as G,T as P,_ as z,_c as X,aa as F,da as j,g as l,ha as m,ia as L,ka as v,ma as u,na as f,o as d,p as a,sb as J,t as y,v as g,w,wa as K,yb as Y,z as b}from"./chunk-YI4P4L32.js";import{a as c,b as x}from"./chunk-QDSGMOWV.js";var O={REMOVE:"remove",SHOW:"show"},ee=(()=>{class t{constructor(){this.strategiesSource=new l({}),this.strategies$=this.strategiesSource.asObservable()}static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275prov=m({token:t,factory:t.\u0275fac})}}return t})(),N=new v("USE_CONFIGURATION_STORE"),k=(()=>{class t{constructor(e=!1,i){this.isolate=e,this.configurationStore=i,this.strategiesSource=this.isolate?new l({}):this.configurationStore.strategiesSource,this.strategies$=this.strategiesSource.asObservable(),this.onAuthorisedDefaultStrategy=this.isolate?void 0:this.configurationStore.onAuthorisedDefaultStrategy,this.onUnAuthorisedDefaultStrategy=this.isolate?void 0:this.configurationStore.onUnAuthorisedDefaultStrategy}setDefaultOnAuthorizedStrategy(e){this.isolate?this.onAuthorisedDefaultStrategy=this.getDefinedStrategy(e):(this.configurationStore.onAuthorisedDefaultStrategy=this.getDefinedStrategy(e),this.onAuthorisedDefaultStrategy=this.configurationStore.onAuthorisedDefaultStrategy)}setDefaultOnUnauthorizedStrategy(e){this.isolate?this.onUnAuthorisedDefaultStrategy=this.getDefinedStrategy(e):(this.configurationStore.onUnAuthorisedDefaultStrategy=this.getDefinedStrategy(e),this.onUnAuthorisedDefaultStrategy=this.configurationStore.onUnAuthorisedDefaultStrategy)}addPermissionStrategy(e,i){this.strategiesSource.value[e]=i}getStrategy(e){return this.strategiesSource.value[e]}getAllStrategies(){return this.strategiesSource.value}getDefinedStrategy(e){if(this.strategiesSource.value[e]||this.isPredefinedStrategy(e))return e;throw new Error(`No ' ${e} ' strategy is found please define one`)}isPredefinedStrategy(e){return e===O.SHOW||e===O.REMOVE}static{this.\u0275fac=function(i){return new(i||t)(u(N),u(ee))}}static{this.\u0275prov=m({token:t,factory:t.\u0275fac})}}return t})();function h(t){return typeof t=="function"}function V(t){if(Object.prototype.toString.call(t)!=="[object Object]")return!1;{let W=Object.getPrototypeOf(t);return W===null||W===Object.prototype}}function ie(t){return!!t&&typeof t=="string"}function A(t){return typeof t=="boolean"}function te(t){return Object.prototype.toString.call(t)==="[object Promise]"}function E(t){return Array.isArray(t)?t.length>0:!!t}function T(t){return ie(t)?[t]:t}var se=(()=>{class t{constructor(){this.permissionsSource=new l({}),this.permissions$=this.permissionsSource.asObservable()}static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275prov=m({token:t,factory:t.\u0275fac})}}return t})(),B=new v("USE_PERMISSIONS_STORE"),S=(()=>{class t{constructor(e=!1,i){this.isolate=e,this.permissionsStore=i,this.permissionsSource=this.isolate?new l({}):this.permissionsStore.permissionsSource,this.permissions$=this.permissionsSource.asObservable()}flushPermissions(){this.permissionsSource.next({})}hasPermission(e){return!e||Array.isArray(e)&&e.length===0?Promise.resolve(!0):(e=T(e),this.hasArrayPermission(e))}loadPermissions(e,i){let s=e.reduce((n,r)=>this.reducePermission(n,r,i),{});this.permissionsSource.next(s)}addPermission(e,i){if(Array.isArray(e)){let s=e.reduce((n,r)=>this.reducePermission(n,r,i),this.permissionsSource.value);this.permissionsSource.next(s)}else{let s=this.reducePermission(this.permissionsSource.value,e,i);this.permissionsSource.next(s)}}removePermission(e){let i=c({},this.permissionsSource.value);delete i[e],this.permissionsSource.next(i)}getPermission(e){return this.permissionsSource.value[e]}getPermissions(){return this.permissionsSource.value}reducePermission(e,i,s){return s&&h(s)?x(c({},e),{[i]:{name:i,validationFunction:s}}):x(c({},e),{[i]:{name:i}})}hasArrayPermission(e){let i=e.map(s=>{if(this.hasPermissionValidationFunction(s)){let n=this.permissionsSource.value[s].validationFunction,r=c({},this.permissionsSource.value);return a(null).pipe(y(()=>n(s,r)),F(o=>A(o)?a(o):o),M(()=>a(!1)))}return a(!!this.permissionsSource.value[s])});return d(i).pipe(w(),P(s=>s!==!1,!1),y(s=>s!==!1)).toPromise().then(s=>s)}hasPermissionValidationFunction(e){return!!this.permissionsSource.value[e]&&!!this.permissionsSource.value[e].validationFunction&&h(this.permissionsSource.value[e].validationFunction)}static{this.\u0275fac=function(i){return new(i||t)(u(B),u(se))}}static{this.\u0275prov=m({token:t,factory:t.\u0275fac})}}return t})(),R=class{constructor(){this.rolesSource=new l({}),this.roles$=this.rolesSource.asObservable()}},$=new v("USE_ROLES_STORE"),D=(()=>{class t{constructor(e=!1,i,s){this.isolate=e,this.rolesStore=i,this.permissionsService=s,this.rolesSource=this.isolate?new l({}):this.rolesStore.rolesSource,this.roles$=this.rolesSource.asObservable()}addRole(e,i){let s=x(c({},this.rolesSource.value),{[e]:{name:e,validationFunction:i}});this.rolesSource.next(s)}addRoleWithPermissions(e,i){this.permissionsService.addPermission(i),this.addRole(e,i)}addRoles(e){Object.keys(e).forEach((i,s)=>{this.addRole(i,e[i])})}addRolesWithPermissions(e){Object.keys(e).forEach((i,s)=>{this.addRoleWithPermissions(i,e[i])})}flushRoles(){this.rolesSource.next({})}flushRolesAndPermissions(){this.flushRoles(),this.permissionsService.flushPermissions()}removeRole(e){let i=c({},this.rolesSource.value);delete i[e],this.rolesSource.next(i)}getRoles(){return this.rolesSource.value}getRole(e){return this.rolesSource.value[e]}hasOnlyRoles(e){return!e||Array.isArray(e)&&e.length===0?Promise.resolve(!0):(e=T(e),Promise.all([this.hasRoleKey(e),this.hasRolePermission(this.rolesSource.value,e)]).then(([s,n])=>s||n))}hasRoleKey(e){let i=e.map(s=>{if(!!this.rolesSource.value[s]&&!!this.rolesSource.value[s].validationFunction&&h(this.rolesSource.value[s].validationFunction)&&!te(this.rolesSource.value[s].validationFunction)){let r=this.rolesSource.value[s].validationFunction,o=c({},this.rolesSource.value);return a(null).pipe(y(()=>r(s,o)),F(p=>A(p)?a(p):p),M(()=>a(!1)))}return a(!1)});return d(i).pipe(w(),P(s=>s!==!1,!1),y(s=>s!==!1)).toPromise().then(s=>s)}hasRolePermission(e,i){return d(i).pipe(g(s=>e[s]&&Array.isArray(e[s].validationFunction)?d(e[s].validationFunction).pipe(g(n=>this.permissionsService.hasPermission(n)),G(n=>n===!0)):a(!1)),P(s=>s===!0,!1)).toPromise()}static{this.\u0275fac=function(i){return new(i||t)(u($),u(R),u(S))}}static{this.\u0275prov=m({token:t,factory:t.\u0275fac})}}return t})(),Pe=(()=>{class t{constructor(){this.permissionsAuthorized=new C,this.permissionsUnauthorized=new C,this.firstMergeUnusedRun=1,this.permissionsService=f(S),this.configurationService=f(k),this.rolesService=f(D),this.viewContainer=f(Y),this.changeDetector=f(X),this.templateRef=f(J)}ngOnInit(){this.viewContainer.clear(),this.initPermissionSubscription=this.validateExceptOnlyPermissions()}ngOnChanges(e){let i=e.ngxPermissionsOnly,s=e.ngxPermissionsExcept;if(i||s){if(i&&i.firstChange||s&&s.firstChange)return;I(this.permissionsService.permissions$,this.rolesService.roles$).pipe(z(this.firstMergeUnusedRun),H(1)).subscribe(()=>{if(E(this.ngxPermissionsExcept)){this.validateExceptAndOnlyPermissions();return}if(E(this.ngxPermissionsOnly)){this.validateOnlyPermissions();return}this.handleAuthorisedPermission(this.getAuthorisedTemplates())})}}ngOnDestroy(){this.initPermissionSubscription&&this.initPermissionSubscription.unsubscribe()}validateExceptOnlyPermissions(){return I(this.permissionsService.permissions$,this.rolesService.roles$).pipe(z(this.firstMergeUnusedRun)).subscribe(()=>{if(E(this.ngxPermissionsExcept)){this.validateExceptAndOnlyPermissions();return}if(E(this.ngxPermissionsOnly)){this.validateOnlyPermissions();return}this.handleAuthorisedPermission(this.getAuthorisedTemplates())})}validateExceptAndOnlyPermissions(){Promise.all([this.permissionsService.hasPermission(this.ngxPermissionsExcept),this.rolesService.hasOnlyRoles(this.ngxPermissionsExcept)]).then(([e,i])=>{if(e||i){this.handleUnauthorisedPermission(this.ngxPermissionsExceptElse||this.ngxPermissionsElse);return}if(this.ngxPermissionsOnly)throw!1;this.handleAuthorisedPermission(this.ngxPermissionsExceptThen||this.ngxPermissionsThen||this.templateRef)}).catch(()=>{this.ngxPermissionsOnly?this.validateOnlyPermissions():this.handleAuthorisedPermission(this.ngxPermissionsExceptThen||this.ngxPermissionsThen||this.templateRef)})}validateOnlyPermissions(){Promise.all([this.permissionsService.hasPermission(this.ngxPermissionsOnly),this.rolesService.hasOnlyRoles(this.ngxPermissionsOnly)]).then(([e,i])=>{e||i?this.handleAuthorisedPermission(this.ngxPermissionsOnlyThen||this.ngxPermissionsThen||this.templateRef):this.handleUnauthorisedPermission(this.ngxPermissionsOnlyElse||this.ngxPermissionsElse)}).catch(()=>{this.handleUnauthorisedPermission(this.ngxPermissionsOnlyElse||this.ngxPermissionsElse)})}handleUnauthorisedPermission(e){if(!(A(this.currentAuthorizedState)&&!this.currentAuthorizedState)){if(this.currentAuthorizedState=!1,this.permissionsUnauthorized.emit(),this.getUnAuthorizedStrategyInput()){this.applyStrategyAccordingToStrategyType(this.getUnAuthorizedStrategyInput());return}this.configurationService.onUnAuthorisedDefaultStrategy&&!this.elseBlockDefined()?this.applyStrategy(this.configurationService.onUnAuthorisedDefaultStrategy):this.showTemplateBlockInView(e)}}handleAuthorisedPermission(e){if(!(A(this.currentAuthorizedState)&&this.currentAuthorizedState)){if(this.currentAuthorizedState=!0,this.permissionsAuthorized.emit(),this.getAuthorizedStrategyInput()){this.applyStrategyAccordingToStrategyType(this.getAuthorizedStrategyInput());return}this.configurationService.onAuthorisedDefaultStrategy&&!this.thenBlockDefined()?this.applyStrategy(this.configurationService.onAuthorisedDefaultStrategy):this.showTemplateBlockInView(e)}}applyStrategyAccordingToStrategyType(e){if(ie(e)){this.applyStrategy(e);return}if(h(e)){this.showTemplateBlockInView(this.templateRef),e(this.templateRef);return}}showTemplateBlockInView(e){this.viewContainer.clear(),e&&(this.viewContainer.createEmbeddedView(e),this.changeDetector.markForCheck())}getAuthorisedTemplates(){return this.ngxPermissionsOnlyThen||this.ngxPermissionsExceptThen||this.ngxPermissionsThen||this.templateRef}elseBlockDefined(){return!!this.ngxPermissionsExceptElse||!!this.ngxPermissionsElse}thenBlockDefined(){return!!this.ngxPermissionsExceptThen||!!this.ngxPermissionsThen}getAuthorizedStrategyInput(){return this.ngxPermissionsOnlyAuthorisedStrategy||this.ngxPermissionsExceptAuthorisedStrategy||this.ngxPermissionsAuthorisedStrategy}getUnAuthorizedStrategyInput(){return this.ngxPermissionsOnlyUnauthorisedStrategy||this.ngxPermissionsExceptUnauthorisedStrategy||this.ngxPermissionsUnauthorisedStrategy}applyStrategy(e){if(e===O.SHOW){this.showTemplateBlockInView(this.templateRef);return}if(e===O.REMOVE){this.viewContainer.clear();return}let i=this.configurationService.getStrategy(e);this.showTemplateBlockInView(this.templateRef),i(this.templateRef)}static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275dir=Q({type:t,selectors:[["","ngxPermissionsOnly",""],["","ngxPermissionsExcept",""]],inputs:{ngxPermissionsOnly:"ngxPermissionsOnly",ngxPermissionsOnlyThen:"ngxPermissionsOnlyThen",ngxPermissionsOnlyElse:"ngxPermissionsOnlyElse",ngxPermissionsExcept:"ngxPermissionsExcept",ngxPermissionsExceptElse:"ngxPermissionsExceptElse",ngxPermissionsExceptThen:"ngxPermissionsExceptThen",ngxPermissionsThen:"ngxPermissionsThen",ngxPermissionsElse:"ngxPermissionsElse",ngxPermissionsOnlyAuthorisedStrategy:"ngxPermissionsOnlyAuthorisedStrategy",ngxPermissionsOnlyUnauthorisedStrategy:"ngxPermissionsOnlyUnauthorisedStrategy",ngxPermissionsExceptUnauthorisedStrategy:"ngxPermissionsExceptUnauthorisedStrategy",ngxPermissionsExceptAuthorisedStrategy:"ngxPermissionsExceptAuthorisedStrategy",ngxPermissionsUnauthorisedStrategy:"ngxPermissionsUnauthorisedStrategy",ngxPermissionsAuthorisedStrategy:"ngxPermissionsAuthorisedStrategy"},outputs:{permissionsAuthorized:"permissionsAuthorized",permissionsUnauthorized:"permissionsUnauthorized"},standalone:!1,features:[K]})}}return t})(),re="default";var _=(()=>{class t{constructor(e,i,s){this.permissionsService=e,this.rolesService=i,this.router=s}canActivate(e,i){return this.hasPermissions(e,i)}canActivateChild(e,i){return this.hasPermissions(e,i)}canLoad(e){return this.hasPermissions(e)}canMatch(e){return this.hasPermissions(e)}hasPermissions(e,i){let s=e&&e.data?e.data.permissions:{},n=this.transformPermission(s,e,i);return this.isParameterAvailable(n.except)?this.passingExceptPermissionsValidation(n,e,i):this.isParameterAvailable(n.only)?this.passingOnlyPermissionsValidation(n,e,i):!0}transformPermission(e,i,s){let n=h(e.only)?e.only(i,s):T(e.only),r=h(e.except)?e.except(i,s):T(e.except),o=e.redirectTo;return{only:n,except:r,redirectTo:o}}isParameterAvailable(e){return!!e&&e.length>0}passingExceptPermissionsValidation(e,i,s){if(e.redirectTo&&(h(e.redirectTo)||V(e.redirectTo)&&!this.isRedirectionWithParameters(e.redirectTo))){let n="";return d(e.except).pipe(g(r=>b([this.permissionsService.hasPermission(r),this.rolesService.hasOnlyRoles(r)]).pipe(j(o=>{o.every(U=>U===!1)||(n=r)}))),P(r=>r.some(o=>o===!0),!1),g(r=>n?(this.handleRedirectOfFailedPermission(e,n,i,s),a(!1)):!r&&e.only?this.onlyRedirectCheck(e,i,s):a(!r))).toPromise()}return Promise.all([this.permissionsService.hasPermission(e.except),this.rolesService.hasOnlyRoles(e.except)]).then(([n,r])=>n||r?(e.redirectTo&&this.redirectToAnotherRoute(e.redirectTo,i,s),!1):e.only?this.checkOnlyPermissions(e,i,s):!0)}redirectToAnotherRoute(e,i,s,n){let r=h(e)?e(n,i,s):e;if(this.isRedirectionWithParameters(r)){r.navigationCommands=this.transformNavigationCommands(r.navigationCommands,i,s),r.navigationExtras=this.transformNavigationExtras(r.navigationExtras,i,s),this.router.navigate(r.navigationCommands,r.navigationExtras);return}Array.isArray(r)?this.router.navigate(r):this.router.navigate([r])}isRedirectionWithParameters(e){return V(e)&&(!!e.navigationCommands||!!e.navigationExtras)}transformNavigationCommands(e,i,s){return h(e)?e(i,s):e}transformNavigationExtras(e,i,s){return h(e)?e(i,s):e}onlyRedirectCheck(e,i,s){let n="";return d(e.only).pipe(g(r=>b([this.permissionsService.hasPermission(r),this.rolesService.hasOnlyRoles(r)]).pipe(j(o=>{o.every(U=>U===!1)&&(n=r)}))),P(r=>h(e.redirectTo)?r.some(o=>o===!0):r.every(o=>o===!1),!1),g(r=>h(e.redirectTo)?r?a(!0):(this.handleRedirectOfFailedPermission(e,n,i,s),a(!1)):(n&&this.handleRedirectOfFailedPermission(e,n,i,s),a(!r)))).toPromise()}handleRedirectOfFailedPermission(e,i,s,n){this.isFailedPermissionPropertyOfRedirectTo(e,i)?this.redirectToAnotherRoute(e.redirectTo[i],s,n,i):h(e.redirectTo)?this.redirectToAnotherRoute(e.redirectTo,s,n,i):this.redirectToAnotherRoute(e.redirectTo[re],s,n,i)}isFailedPermissionPropertyOfRedirectTo(e,i){return!!e.redirectTo&&e.redirectTo[i]}checkOnlyPermissions(e,i,s){let n=c({},e);return Promise.all([this.permissionsService.hasPermission(n.only),this.rolesService.hasOnlyRoles(n.only)]).then(([r,o])=>r||o?!0:(n.redirectTo&&this.redirectToAnotherRoute(n.redirectTo,i,s),!1))}passingOnlyPermissionsValidation(e,i,s){return h(e.redirectTo)||V(e.redirectTo)&&!this.isRedirectionWithParameters(e.redirectTo)?this.onlyRedirectCheck(e,i,s):this.checkOnlyPermissions(e,i,s)}static{this.\u0275fac=function(i){return new(i||t)(u(S),u(D),u(Z))}}static{this.\u0275prov=m({token:t,factory:t.\u0275fac})}}return t})();var pe=(()=>{class t{static forRoot(e={}){return{ngModule:t,providers:[se,R,ee,S,_,D,k,{provide:B,useValue:e.permissionsIsolate},{provide:$,useValue:e.rolesIsolate},{provide:N,useValue:e.configurationIsolate}]}}static forChild(e={}){return{ngModule:t,providers:[{provide:B,useValue:e.permissionsIsolate},{provide:$,useValue:e.rolesIsolate},{provide:N,useValue:e.configurationIsolate},k,S,D,_]}}static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275mod=q({type:t})}static{this.\u0275inj=L({})}}return t})();export{S as a,D as b,Pe as c,_ as d,pe as e};
